<!DOCTYPE html>
<html>
<head>
	<link rel="shortcut icon" href="/resources/favicon.ico">
	<meta charset="UTF-8">
	<script src="https://unpkg.com/vue/dist/vue.js"></script>
	<link rel="stylesheet" type="text/css" href="/stylesheets/dashboard-b9e476d4644bc0425e47b196fac5d10d.css">
	<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
	<link href="https://fonts.googleapis.com/css?family=Work+Sans" rel="stylesheet">
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script type="text/javascript" src="https:////cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js"></script>
	<script type="text/javascript" src="/js/moment-timezone-with-data.js"></script>
	<script type="text/javascript" src="/js/lodash.js"></script>
	<link rel="stylesheet" type="text/css" href="/stylesheets/sweetalert.css">
	<script src="/js/sweetalert.min.js"></script>

	<script type="text/javascript" src="/js/dashboard.js"></script>
	<link rel="stylesheet" type="text/css" href="/stylesheets/dashboard.css">
	<link rel="stylesheet" type="text/css" href="/stylesheets/header.css">
</head>

<body class="ember-application" cz-shortcut-listen="true">
	<nav class="glostick">
		<div class="glostick__modal-bg"></div>
		<div class="glostick__property">
			<a class="glostick__property__name" href="/dashboard">
				<img src="/resources/world-clock-icon-40.png" alt="Logo">
				<img src="/resources/world-clock-logo-small.png" alt="Logo">
				<!-- <i class="icon icon-logo dashboard-logo"></i> -->
				<!-- <span class="heroku-wordmark"></span> -->
			</a>
		</div>


		<div class="glostick__user">
      <!-- <a class="glostick__menu-icon" id="world-clock-menu-icon">
        <div class="icon icon-navigator-toggle"></div>
      </a>

      <div class="glostick__menu glostick__menu--navigator">
        <a class="glostick__menu__item glostick__menu__item--dashboard" href="#">Dashboard</a>
        <a class="glostick__menu__item glostick__menu__item--databases" href="#">Data</a>
        <a class="glostick__menu__item glostick__menu__item--dataclips" href="#">Dataclips</a>
        <a class="glostick__menu__item glostick__menu__item--elements" href="#">Elements</a>
        <a class="glostick__menu__item glostick__menu__item--docs" href="#">Documentation</a>
        <a class="glostick__menu__item glostick__menu__item--support" href="#">Support</a>

    </div> -->


    <a class="glostick__menu-icon glostick__menu-icon--account" id="world-clock-user-icon">
    	<div class="glostick__user__avatar--container">
    		<img class="glostick__user__avatar" src="/resources/invasion.png">
    	</div>
    	<div class="glostick__user__notification"></div>
    </a>

    <div class="glostick__menu glostick__menu--account">
    	<a class="glostick__menu__item glostick__menu__item--account-details" href="/edit_profile">
    		<div class="glostick__user__avatar--container">
    			<img class="glostick__account-details__avatar" src="/resources/invasion.png">
    		</div>
    		<div class="glostick__account-details__name">
    			Anonymous
    		</div>
    		<div class="glostick__account-details__email">
    			unknown@email.com
    		</div>
    	</a>
    	<a class="glostick__menu__item glostick__menu__item--settings" href="/edit_profile">Account settings</a>

        <!-- <a class="glostick__menu__item glostick__menu__item--notifications" href="#">
          Notifications

      </a> -->

      <a class="glostick__menu__item glostick__menu__item--signout" onclick='logout()'>Sign out</a>

  </div>

</div>


<div class="quick-jump" style="display: block;">
	<div class="quick-jump__filter__wrap">
		<span class="quick-jump__filter__wrap--tt" style="position: relative; display: inline-block;">
			<input class="quick-jump__filter form-control" placeholder="Jump to Events..." autocomplete="off" spellcheck="false" dir="auto" style="position: relative; vertical-align: top;" type="text" id="searchbox">
			<pre aria-hidden="true" style="position: absolute; visibility: hidden; white-space: pre; font-family: benton-sans,&quot;Helvetica Neue&quot;,sans-serif; font-size: 13px; font-style: normal; font-variant: normal; font-weight: 400; word-spacing: 0px; letter-spacing: 0px; text-indent: 0px; text-rendering: optimizelegibility; text-transform: none;"></pre>
			<div class="quick-jump__results" style="position: absolute; top: 100%; left: 0px; z-index: 100; display: none;"><div class="quick-jump__list list-group list-group-0"></div>
		</div>
	</span>
</div>
</div>
</nav>


<div id="hk-slide-panels"></div>
<div id="modal-overlays"></div><div id="ember380" class="ember-view"><div id="ember407" class="app-wrapper protected-apps-index ember-view"><div id="ember414" class="ember-view"><!----></div>

<div id="ember417" class="flash-messages ember-view"><ul class="list-unstyled">
</ul>
</div>

<div class="main-panel">
	<div id="ember804" style="display: none;" class="sms-nag-banner ember-view"><div class="global-notification is-warning">
		<p class="pull-left">

			<svg style="width: 17px; height: 17px;" data-test-target="malibu-icon" data-test-icon-name="device-16" class="icon malibu-icon malibu-fill-gradient-orange">
				<title></title>
				<use xlink="http://www.w3.org/1999/xlink" xlink:href="#device-16"></use>
			</svg>

			We recommend you add a backup phone number for account recovery purposes.
		</p>

		<div class="notification-actions pull-right">
			<button class="btn btn-default btn-warning btn-xs notification-hide" data-ember-action="" data-ember-action-805="805">
				Skip
			</button>

			<button class="btn btn-warning btn-xs notification-action" data-ember-action="" data-ember-action-806="806">
				Add Phone Number
			</button>
		</div>
	</div>
</div>

<div class="top-nav">
	<div class="limit-width">
		<div class="context-switcher--container">
			<div id="ember812" class="context-switcher ember-view"><div id="ember817" class="context-switcher__button ember-view">
				<div class="userIcon">
					<img src="/resources/user1.png" alt="icon">	
				</div>
				<span class="name mh2">Personal events</span>
			</div>
		</div>
	</div>

	<div class="btn-group actions-button">
		<div id="ember859" class="btn-group ember-view"><button onclick="window.location.href='/event/new'" type="button" class="drop-down__toggle btn btn-default btn-sm" data-ember-action="" data-ember-action-865="865">
			New <i class="fa fa-plus" aria-hidden="true"></i>
		</button>


	</div>
</div>


</div>
</div>

<div class="main-content">
	<div id="app-list">
		<div id="event-list">
			<div class="app-list" v-for="event in orderById">
				<div :id="event.id" class="apps-item list-group-item list-group-item-link ember-view">
					<div :id="event.id" class="ember-view">
						<div class="app-icon">
							<div :id="event.id" class="metrics__active-alert__app-icon ember-view">
								<img src="/resources/hexagon-icon.png">

							</div>
						</div>
						<span class="app-name">
							<a :href="setURL(event)" :id="event.id" class="ember-view">
								{{event.name}}
							</a>
						</span>
						<div class="apps-item__meta visible-lg visible-md ml3 mr2">
							<ol class="stack-info">
								<li>
									<a class="ember-view">
										<i class="fa fa-clock-o" aria-hidden="true"></i>
										{{event.duration}}
									</a>
								</li>
								<li>
									<a class="ember-view">
										{{event.startTime}}
									</a>
								</li>
								<li class="region">
									<a class="ember-view">
										<i class="fa fa-home" aria-hidden="true"></i>
										{{event.place}}
									</a>
								</li>
								<li class="region">
									<a class="ember-view delete-event" @click='deleteEvent(event,true)'>
										<i class="fa fa-trash" aria-hidden="true"></i>
									</a>
								</li>
							</ol>
						</div>
					</div>
				</div>
			</div>

			<div class="passedEvent" v-show="passedEvents.length">Passed Events</div>

			<div class="app-list" v-for="event in orderByOldId">
				<div :id="event.id" class="apps-item list-group-item list-group-item-link ember-view">
					<div :id="event.id" class="ember-view">
						<div class="app-icon">
							<div :id="event.id" class="metrics__active-alert__app-icon ember-view">
								<img src="/resources/hexagon-icon-2.png">

							</div>
						</div>
						<span class="app-name">
							<a :href="setURL(event)" :id="event.id" class="ember-view disable-event">
								{{event.name}}
							</a>
						</span>
						<div class="apps-item__meta visible-lg visible-md ml3 mr2">
							<ol class="stack-info">
								<li>
									<a class="ember-view disable-event">
										<i class="fa fa-clock-o" aria-hidden="true"></i>
										{{event.duration}}
									</a>
								</li>
								<li>
									<a class="ember-view disable-event">
										{{event.startTime}}
									</a>
								</li>
								<li class="region">
									<a class="ember-view disable-event">
										<i class="fa fa-home" aria-hidden="true"></i>
										{{event.place}}
									</a>
								</li>
								<li class="region">
									<a class="ember-view delete-event" @click='deleteEvent(event,false)'>
										<i class="fa fa-trash" aria-hidden="true"></i>
									</a>
								</li>
							</ol>
						</div>
					</div>
				</div>
			</div>
			<div class="addNewEvent" v-show="!(passedEvents.length+events.length)">
				<span>Try to add a new event here</span>
				<button onclick="window.location.href='/event/new'"><i class="fa fa-plus" aria-hidden="true"></i></button>
			</div>
		</div>
	</div>


</div>

<div id="ember837" class="app-footer allow-if-delinquent ember-view"><div class="section-content">
	<ul class="list-inline">
		<li class="hidden-xs"><a href="http://codeenginestudio.com/">codeenginestudio.com</a></li>
	</ul>
	<ul class="list-inline footer-actions">
		<li>
		<a href="/about_us" target="_blank" class="btn btn-primary btn-xs u-margin-Rs">About us</a>
		</li>
	</ul>
	<ul class="list-inline">
    <!-- <li><a href="#">Terms of Service</a></li>
    <li><a href="#">Privacy</a></li>
    <li><a href="#">Cookies</a></li> -->
    <li>Â© 2017 CES Interns</li>
</ul>
</div>
</div>
</div>

<script>
	const eventlist = new Vue({
		el: '#event-list',
		data: {
			events: [],
			passedEvents: []
		},
		computed: {
			orderById: function() {
				return _.orderBy(this.events, 'id', 'asc');
			},
			orderByOldId: function() {
				return _.orderBy(this.passedEvents, 'id', 'asc');
			}
		},
		methods: {
			setEvent: function() {
				var _this = this;
				_this.events = [];
				var sPageURL = window.location;
				// console.log("sPageURL.pathname = " + sPageURL.pathname);
				if (sPageURL.pathname == "/dashboard") {
					var d = {
						"token": localStorage.getItem("user_token"),
					};
					// console.log(d);
					$.ajax({
						url: 'https://worldclock-intern.herokuapp.com/showevents',
						type: 'POST',
						data: JSON.stringify(d),
						dataType: 'json',
						headers:{
							'Content-Type':"application/json; charset=utf-8",
							'Accept':'application/json',
							"Authorization": "Token token=" + localStorage.getItem("user_token")
						},
						complete: function (xhr) {
							if(xhr.status==200) {
								var resList = JSON.parse(xhr.responseText)["result"];
								for (var i = 0; i < resList.length; i++) {
									var isPassed = _this.isDatePassed(_this.setDate(resList[i][3]),resList[i][4]);
									if (isPassed) {
										_this.passedEvents.push({
											id: resList[i][0],
											name: resList[i][1],
											duration: _this.setDuration(resList[i][2]),
											startTime: _this.setStartTime(resList[i][3]),
											place: _this.setPlace(resList[i][5],resList[i][6]),
											date: _this.setDate(resList[i][3])
										});
									} else {
										_this.events.push({
											id: resList[i][0],
											name: resList[i][1],
											duration: _this.setDuration(resList[i][2]),
											startTime: _this.setStartTime(resList[i][3]),
											place: _this.setPlace(resList[i][5],resList[i][6]),
											date: _this.setDate(resList[i][3])
										});
									}
								}
							}
							else {
							}
						}
					});
				} else if (sPageURL.pathname == "/dashboard/search") {
					var d = {
						"token": localStorage.getItem("user_token"),
						"event_name": _this.getKeyword()
					};
					$.ajax({
						url: 'https://worldclock-intern.herokuapp.com/searchevent',
						type: 'POST',
						data: JSON.stringify(d),
						dataType: 'json',
						headers:{
							'Content-Type':"application/json; charset=utf-8",
							'Accept':'application/json',
							"Authorization": "Token token=" + localStorage.getItem("user_token")
						},
						complete: function (xhr) {
							if(xhr.status==200) {
								var resList = JSON.parse(xhr.responseText)["result"];

								for (var i = 0; i < resList.length; i++) {
									var isPassed = _this.isDatePassed(_this.setDate(resList[i][3]),resList[i][4]);
									if (isPassed) {
										_this.passedEvents.push({
											id: resList[i][0],
											name: resList[i][1],
											duration: _this.setDuration(resList[i][2]),
											startTime: _this.setStartTime(resList[i][3]),
											place: _this.setPlace(resList[i][5],resList[i][6]),
											date: _this.setDate(resList[i][3])
										});
									} else {
										_this.events.push({
											id: resList[i][0],
											name: resList[i][1],
											duration: _this.setDuration(resList[i][2]),
											startTime: _this.setStartTime(resList[i][3]),
											place: _this.setPlace(resList[i][5],resList[i][6]),
											date: _this.setDate(resList[i][3])
										});
									}
								}
							}
							else {
							}
						}
					});
				}
			},
			getKeyword: function() {
				var keyword = window.location.search;
				keyword = keyword.split("=");
				return decodeURI(keyword[1]);
			},
			isDatePassed: function(str,tz) {
				var today = new Date();
				var comparedDay = moment(str,"MMM DD YYYY HH:mm:ss").add(this.getCurrentTimezone()-tz,"hours").format("MMM DD YYYY HH:mm:ss");
				comparedDay = new Date(comparedDay);
				if (comparedDay < today) {
					return true;
				} else {
					return false;
				}
			},
			getCurrentTimezone: function(){
				var tz = moment().format('Z');
				tzArray = tz.split(":");
				var cTz = parseInt(tzArray[0])+parseInt(tzArray[1])/60;
				return cTz;
			},
			setURL: function(event) {
				return "/event/" + event.id;
			},
			setDuration: function(DurationStr) {
				var _this = this;
				var duration = parseInt(DurationStr);
				return _this.convertTime(duration);
			},
			convertTime: function(timeInt) {
				var timeConvertStr;

				timeConvertStr = Math.floor(parseInt(timeInt) / 60);
				if (timeConvertStr == "0") timeConvertStr = "";
				else if (timeConvertStr > 1) timeConvertStr += " hours";
				else timeConvertStr += " hour";

				var timeMinute =  parseInt(timeInt) % 60;
				if (timeMinute != "0") timeConvertStr += " " + timeMinute + " mins";
				if (!timeConvertStr) return "0 min";
				return timeConvertStr;
			},
			setStartTime: function(DateTimeStr) {
				var _this = this;
				var startDateTime = _this.getDateTimeStrSplit(DateTimeStr);
				var startTime = startDateTime[3];

				var startTimeSplit = startTime.split(":");
				var startTime = startTimeSplit[0] + ":" + startTimeSplit[1];

				startDateTime = startTime + ", " + startDateTime[1] + " " + startDateTime[2] + _this.convertDate(startDateTime[3]) + " " + startDateTime[4];
				return startDateTime;
			},
			convertDate: function(dateStr) {
				switch(dateStr[dateStr.length-1]) {
					case "1":
					return "st";
					break;
					case "2":
					return "nd";
					break;
					case "3":
					return "rd";
					break;
					default:
					return "th";
				}
			},
			setPlace: function(cityStr, countryStr) {
				return cityStr + ", " + countryStr;
			},
			getDateTimeStrSplit: function(str) {
				var _this = this;
				var startDateTime = str.split(" ");
				var startDateTimeArr = startDateTime;
				startDateTime = [];
				for (var i = 0; i < startDateTimeArr.length; i++) {
					if (startDateTimeArr[i] != "") {
						startDateTime.push(startDateTimeArr[i]);
					}
				}
				return startDateTime;
			},
			setDate: function(str) {
				var _this = this;
				var DateTimeStr = _this.getDateTimeStrSplit(str);
				var resStr = DateTimeStr[1] + " " + DateTimeStr[2] + " " + DateTimeStr[4] +" " + DateTimeStr[3];
				return resStr;
			},
			deleteEvent: function(event,type) {
				var _this = this;
				if(type) var events = this.events;
				else var events = this.passedEvents;
				var index;
				for (var i in events) {
					if (events[i] == event) index = i;
				}
				swal({
					title: "Are you sure?",
					text: "You will not be able to recover this event!",
					type: "warning",
					showCancelButton: true,
					confirmButtonColor: "#DD6B55",
					confirmButtonText: "Yes, delete it!",
					closeOnConfirm: false
				},
				function(){
					var d = {
						"token": localStorage.getItem("user_token"),
						"event_id": event.id
					};
					// console.log(d);
					$.ajax({
						url: 'https://worldclock-intern.herokuapp.com/deleteevent',
						type: 'POST',
						data: JSON.stringify(d),
						dataType: 'json',
						headers:{
							'Content-Type':"application/json; charset=utf-8",
							'Accept':'application/json',
							"Authorization": "Token token=" + localStorage.getItem("user_token")
						},
						complete: function (xhr) {
							if(xhr.status==200) {
								events.splice(index, 1);
								swal("Deleted!", "Your event has been deleted.", "success");
							}
							else {
							}
						}
					});
				});
			},
		}
	});
</script>

</body>
</html>
